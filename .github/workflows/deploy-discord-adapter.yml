name: Deploy Lily-Discord-Adapter to Production

on:
  repository_dispatch:
    types: [lily-discord-adapter-pushed]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Fetch Secrets from Key Vault
      id: kv
      uses: azure/CLI@v1
      with:
        inlineScript: |
          DISCORD_TOKEN=$(az keyvault secret show --vault-name nstutcommonkv --name discord-bot-token --query value -o tsv)
          CONSUL_ADDR=$(az keyvault secret show --vault-name nstutcommonkv --name consul-http-addr --query value -o tsv)
          VPS_HOST=$(az keyvault secret show --vault-name nstutcommonkv --name vps-host --query value -o tsv)
          VPS_USER=$(az keyvault secret show --vault-name nstutcommonkv --name vps-username --query value -o tsv)
          VPS_PASS=$(az keyvault secret show --vault-name nstutcommonkv --name vps-password --query value -o tsv)
          DOMAIN_NAME=$(az keyvault secret show --vault-name nstutcommonkv --name domain-name --query value -o tsv)
          
          echo "::add-mask::$DISCORD_TOKEN"
          echo "::add-mask::$CONSUL_ADDR"
          echo "::add-mask::$VPS_HOST"
          echo "::add-mask::$VPS_USER"
          echo "::add-mask::$VPS_PASS"
          echo "::add-mask::$DOMAIN_NAME"
          
          echo "DISCORD_BOT_TOKEN=$DISCORD_TOKEN" >> $GITHUB_OUTPUT
          echo "CONSUL_HTTP_ADDR=$CONSUL_ADDR" >> $GITHUB_OUTPUT
          echo "VPS_HOST=$VPS_HOST" >> $GITHUB_OUTPUT
          echo "VPS_USERNAME=$VPS_USER" >> $GITHUB_OUTPUT
          echo "VPS_PASSWORD=$VPS_PASS" >> $GITHUB_OUTPUT
          echo "DOMAIN_NAME=$DOMAIN_NAME" >> $GITHUB_OUTPUT

    - name: Deploy to VPS
      uses: appleboy/ssh-action@v1.0.3
      env:
        DISCORD_BOT_TOKEN: ${{ steps.kv.outputs.DISCORD_BOT_TOKEN }}
        CONSUL_ADDR: ${{ steps.kv.outputs.CONSUL_HTTP_ADDR }}
        DOMAIN_NAME: ${{ steps.kv.outputs.DOMAIN_NAME }}
      with:
        host: ${{ steps.kv.outputs.VPS_HOST }}
        username: ${{ steps.kv.outputs.VPS_USERNAME }}
        password: ${{ steps.kv.outputs.VPS_PASSWORD }}
        port: 22
        timeout: 120s
        envs: DISCORD_BOT_TOKEN,CONSUL_ADDR,DOMAIN_NAME
        script: |
          cd /root/LilyIV

          # Always use latest tag
          IMAGE_TAG="latest"
          
          # Create directory structure for .env files
          mkdir -p Lily-Core Lily-Discord-Adapter

          # Update .env file with required environment variables
          echo "DISCORD_BOT_TOKEN=$DISCORD_BOT_TOKEN" > Lily-Discord-Adapter/.env
          echo "CONSUL_HTTP_ADDR=$CONSUL_ADDR" >> Lily-Discord-Adapter/.env
          echo "DOMAIN_NAME=$DOMAIN_NAME" >> Lily-Discord-Adapter/.env

          # Pull the image
          echo "Pulling nstut/lily-discord-adapter:$IMAGE_TAG"
          docker pull nstut/lily-discord-adapter:$IMAGE_TAG

          # Restart only lily-discord-adapter service
          docker compose -f docker-compose.prod.yml up -d --no-deps lily-discord-adapter

          # Verify deployment
          echo "Deployment completed at $(date)"
          docker ps --filter "name=lily-discord-adapter" --format "table {{.Names}}\t{{.Status}}"
