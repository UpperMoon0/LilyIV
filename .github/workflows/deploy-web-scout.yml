name: Deploy Web-Scout to Production

on:
  repository_dispatch:
    types: [web-scout-pushed]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Fetch Secrets from Key Vault
      id: kv
      uses: azure/CLI@v1
      with:
        inlineScript: |
          GEMINI_KEY=$(az keyvault secret show --vault-name nstutcommonkv --name gemini-api-key --query value -o tsv)
          CONSUL_ADDR=$(az keyvault secret show --vault-name nstutcommonkv --name consul-http-addr --query value -o tsv)
          VPS_HOST=$(az keyvault secret show --vault-name nstutcommonkv --name vps-host --query value -o tsv)
          VPS_USER=$(az keyvault secret show --vault-name nstutcommonkv --name vps-username --query value -o tsv)
          VPS_PASS=$(az keyvault secret show --vault-name nstutcommonkv --name vps-password --query value -o tsv)
          
          echo "::add-mask::$GEMINI_KEY"
          echo "::add-mask::$CONSUL_ADDR"
          echo "::add-mask::$VPS_HOST"
          echo "::add-mask::$VPS_USER"
          echo "::add-mask::$VPS_PASS"
          
          echo "GEMINI_API_KEY=$GEMINI_KEY" >> $GITHUB_OUTPUT
          echo "CONSUL_HTTP_ADDR=$CONSUL_ADDR" >> $GITHUB_OUTPUT
          echo "VPS_HOST=$VPS_HOST" >> $GITHUB_OUTPUT
          echo "VPS_USERNAME=$VPS_USER" >> $GITHUB_OUTPUT
          echo "VPS_PASSWORD=$VPS_PASS" >> $GITHUB_OUTPUT

    - name: Deploy to VPS
      uses: appleboy/ssh-action@v1.0.3
      env:
        GEMINI_KEY: ${{ steps.kv.outputs.GEMINI_API_KEY }}
        CONSUL_ADDR: ${{ steps.kv.outputs.CONSUL_HTTP_ADDR }}
      with:
        host: ${{ steps.kv.outputs.VPS_HOST }}
        username: ${{ steps.kv.outputs.VPS_USERNAME }}
        password: ${{ steps.kv.outputs.VPS_PASSWORD }}
        port: 22
        timeout: 120s
        envs: GEMINI_KEY,CONSUL_ADDR
        script: |
          cd /root/LilyIV

          # Always use latest tag
          IMAGE_TAG="latest"
          
          # Create directory structure for .env files
          mkdir -p Web-Scout

          # Update .env file with required environment variables
          echo "GEMINI_API_KEY=$GEMINI_KEY" > Web-Scout/.env
          echo "CONSUL_HTTP_ADDR=$CONSUL_ADDR" >> Web-Scout/.env

          # Pull the image
          echo "Pulling nstut/web-scout:$IMAGE_TAG"
          docker pull nstut/web-scout:$IMAGE_TAG

          # Restart only web-scout service
          docker compose -f docker-compose.prod.yml up -d --no-deps web-scout

          # Verify deployment
          echo "Deployment completed at $(date)"
          docker ps --filter "name=web-scout" --format "table {{.Names}}\t{{.Status}}"
