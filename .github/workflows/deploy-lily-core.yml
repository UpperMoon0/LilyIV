name: Deploy Lily-Core to Production

on:
  repository_dispatch:
    types: [lily-core-pushed]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Deploy to VPS
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USERNAME }}
        password: ${{ secrets.VPS_PASSWORD }}
        port: 22
        timeout: 300s
        script: |
          cd /root/LilyIV

          # Always use latest tag
          IMAGE_TAG="latest"
          
          # Create directory structure for .env files
          mkdir -p Lily-Core Lily-Discord-Adapter

          # Update .env file with required environment variables
          echo "CONSUL_HTTP_ADDR=${{ secrets.CONSUL_HTTP_ADDR }}" > Lily-Core/.env

          # Pull the image
          echo "Pulling nstut/lily-core:$IMAGE_TAG"
          docker pull nstut/lily-core:$IMAGE_TAG

          # Restart only lily-core service
          docker compose -f docker-compose.prod.yml up -d --no-deps lily-core

          # Verify deployment
          echo "Deployment completed at $(date)"
          docker ps --filter "name=lily-core" --format "table {{.Names}}\t{{.Status}}"
