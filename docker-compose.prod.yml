# Docker Compose for Lily-Core and Lily-Discord-Adapter (Production)
# Uses external nstut-network for connectivity
# Pulls images from Docker Hub instead of building locally
name: lily

services:
  # Lily-Core Application - Main chatbot service (C++)
  lily-core:
    image: nstut/lily-core:latest
    container_name: lily-core
    restart: unless-stopped
    ports:
      - "8000:8000"
      - "9002:9002"
    env_file:
      - ./Lily-Core/.env
    networks:
      nstut-network:
        ipv4_address: 172.18.0.10
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.lily-core.rule=Host(`lily-core.nstut.cloud`)"
      - "traefik.http.routers.lily-core.entrypoints=websecure"
      - "traefik.http.routers.lily-core.tls.certresolver=myresolver"
      - "traefik.http.services.lily-core.loadbalancer.server.port=8000"

  # Lily-Discord-Adapter - Discord bot adapter for Lily-Core
  # Note: No Traefik config - Discord adapter communicates directly with Discord API
  lily-discord-adapter:
    image: nstut/lily-discord-adapter:latest
    container_name: lily-discord-adapter
    restart: unless-stopped
    ports:
      - "8004:8004"
    env_file:
      - ./Lily-Discord-Adapter/.env
    environment:
      - PYTHONUNBUFFERED=1
      - PORT=8004
    networks:
      nstut-network:
        ipv4_address: 172.18.0.20
    depends_on:
      - lily-core
      - consul

  # Consul - Service Registry
  consul:
    image: hashicorp/consul:latest
    container_name: consul
    restart: unless-stopped
    ports:
      - "8500:8500"
      - "8600:8600/udp"
    networks:
      nstut-network:
        ipv4_address: 172.18.0.100
    command: "agent -dev -client '0.0.0.0'"

networks:
  nstut-network:
    name: nstut-network
    external: true

volumes:
  lily-discord-adapter-data:
    driver: local
