# Docker Compose for Lily-Core and Lily-Discord-Adapter (Production)
# Uses external nstut-network for connectivity
# Pulls images from Docker Hub instead of building locally
name: lily

services:
  # Lily-Core Application - Main chatbot service (C++)
  lily-core:
    image: nstut/lily-core:latest
    container_name: lily-core
    restart: unless-stopped
    ports:
      - "8000:8000"
      - "9002:9002"
    env_file:
      - ./Lily-Core/.env
    networks:
      nstut-network:
        ipv4_address: 172.18.0.10
    labels:
      - "traefik.enable=true"
      # CORS Middleware - Allow requests from Lily Admin UI
      - "traefik.http.middlewares.lily-core-cors.headers.accesscontrolallowmethods=GET,POST,OPTIONS,PUT,DELETE"
      - "traefik.http.middlewares.lily-core-cors.headers.accesscontrolallowheaders=*"
      - "traefik.http.middlewares.lily-core-cors.headers.accesscontrolalloworiginlist=https://lily-admin-ui.vercel.app"
      - "traefik.http.middlewares.lily-core-cors.headers.accesscontrolmaxage=100"
      - "traefik.http.middlewares.lily-core-cors.headers.addvaryheader=true"
      # Service definitions
      - "traefik.http.services.lily-core-http.loadbalancer.server.port=8000"
      - "traefik.http.services.lily-core-ws.loadbalancer.server.port=9002"
      # HTTP API router (port 8000) - all paths except /ws
      - "traefik.http.routers.lily-core.rule=Host(`lily-core.nstut.cloud`) && !PathPrefix(`/ws`)"
      - "traefik.http.routers.lily-core.entrypoints=websecure"
      - "traefik.http.routers.lily-core.tls.certresolver=myresolver"
      - "traefik.http.routers.lily-core.middlewares=lily-core-cors"
      - "traefik.http.routers.lily-core.service=lily-core-http"
      # WebSocket router (port 9002) - path /ws
      - "traefik.http.routers.lily-core-ws.rule=Host(`lily-core.nstut.cloud`) && PathPrefix(`/ws`)"
      - "traefik.http.routers.lily-core-ws.entrypoints=websecure"
      - "traefik.http.routers.lily-core-ws.tls.certresolver=myresolver"
      - "traefik.http.routers.lily-core-ws.middlewares=lily-core-cors"
      - "traefik.http.routers.lily-core-ws.service=lily-core-ws"

  # Lily-Discord-Adapter - Discord bot adapter for Lily-Core
  # Note: No Traefik config - Discord adapter communicates directly with Discord API
  lily-discord-adapter:
    image: nstut/lily-discord-adapter:latest
    container_name: lily-discord-adapter
    restart: unless-stopped
    ports:
      - "8004:8004"
    env_file:
      - ./Lily-Discord-Adapter/.env
    environment:
      - PYTHONUNBUFFERED=1
      - PORT=8004
    networks:
      nstut-network:
        ipv4_address: 172.18.0.20
    depends_on:
      - lily-core
      - consul

  # Consul - Service Registry
  consul:
    image: hashicorp/consul:latest
    container_name: consul
    restart: unless-stopped
    ports:
      - "8500:8500"
      - "8600:8600/udp"
    networks:
      nstut-network:
        ipv4_address: 172.18.0.100
    command: "agent -dev -client '0.0.0.0' -ui"
    labels:
      - "traefik.enable=true"
      # CORS Middleware - Allow requests from Lily Admin UI
      - "traefik.http.middlewares.consul-cors.headers.accesscontrolallowmethods=GET,OPTIONS,PUT"
      - "traefik.http.middlewares.consul-cors.headers.accesscontrolallowheaders=*"
      - "traefik.http.middlewares.consul-cors.headers.accesscontrolalloworiginlist=https://lily-admin-ui.vercel.app"
      - "traefik.http.middlewares.consul-cors.headers.accesscontrolmaxage=100"
      - "traefik.http.middlewares.consul-cors.headers.addvaryheader=true"
      # HTTP API (port 8500)
      - "traefik.http.routers.consul-api.rule=Host(`consul-api.nstut.cloud`)"
      - "traefik.http.routers.consul-api.entrypoints=websecure"
      - "traefik.http.routers.consul-api.tls.certresolver=myresolver"
      - "traefik.http.routers.consul-api.middlewares=consul-cors"
      - "traefik.http.services.consul-api.loadbalancer.server.port=8500"
      # UI Dashboard (port 8500 - same port, different router)
      - "traefik.http.routers.consul-ui.rule=Host(`consul.nstut.cloud`)"
      - "traefik.http.routers.consul-ui.entrypoints=websecure"
      - "traefik.http.routers.consul-ui.tls.certresolver=myresolver"
      - "traefik.http.routers.consul-ui.middlewares=consul-cors"
      - "traefik.http.services.consul-ui.loadbalancer.server.port=8500"

networks:
  nstut-network:
    name: nstut-network
    external: true

volumes:
  lily-discord-adapter-data:
    driver: local
