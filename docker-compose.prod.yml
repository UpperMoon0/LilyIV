# Docker Compose for Lily-Core and Lily-Discord-Adapter (Production)
# Uses external nstut-network for connectivity
# Pulls images from Docker Hub instead of building locally
name: lily

services:
  # Lily-Core Application - Main chatbot service (C++)
  lily-core:
    image: nstut/lily-core:latest
    container_name: lily-core
    restart: unless-stopped
    ports:
      - "8000:8000"
    volumes:
      - lily-core-data:/app/data
    networks:
      nstut-network:
        ipv4_address: 172.18.0.10
    environment:
      - LOG_LEVEL=INFO
    env_file:
      - ./Lily-Core/.env
    depends_on:
      consul:
        condition: service_healthy
    labels:
      - "traefik.enable=true"
      
      # HTTP Service definition (port 8000)
      - "traefik.http.services.lily-core-http.loadbalancer.server.port=8000"
      
      # HTTP API router (port 8000)
      - "traefik.http.routers.lily-core.rule=Host(`lily-core.nstut.cloud`)"
      - "traefik.http.routers.lily-core.entrypoints=websecure"
      - "traefik.http.routers.lily-core.tls.certresolver=myresolver"
      - "traefik.http.routers.lily-core.service=lily-core-http"
      
      # WebSocket router (port 8000 via /ws prefix)
      - "traefik.http.routers.lily-core-ws.rule=Host(`lily-core.nstut.cloud`) && PathPrefix(`/ws`)"
      - "traefik.http.routers.lily-core-ws.priority=100"
      - "traefik.http.routers.lily-core-ws.entrypoints=websecure"
      - "traefik.http.routers.lily-core-ws.tls.certresolver=myresolver"
      - "traefik.http.routers.lily-core-ws.service=lily-core-http"

  # Lily-Discord-Adapter - Discord bot adapter for Lily-Core
  lily-discord-adapter:
    image: nstut/lily-discord-adapter:latest
    container_name: lily-discord-adapter
    restart: unless-stopped
    ports:
      - "8004:8004"
    env_file:
      - ./Lily-Discord-Adapter/.env
    environment:
      - PYTHONUNBUFFERED=1
      - PORT=8004
    volumes:
      - lily-discord-adapter-data:/app/data
    networks:
      nstut-network:
        ipv4_address: 172.18.0.20
    depends_on:
      lily-core:
        condition: service_started
      consul:
        condition: service_healthy
    labels:
      - "traefik.enable=true"
      # Service definition
      - "traefik.http.services.lily-discord-adapter.loadbalancer.server.port=8004"
      # HTTP API router
      - "traefik.http.routers.lily-discord-adapter.rule=Host(`lily-discord-adapter.nstut.cloud`)"
      - "traefik.http.routers.lily-discord-adapter.entrypoints=websecure"
      - "traefik.http.routers.lily-discord-adapter.tls.certresolver=myresolver"
      - "traefik.http.routers.lily-discord-adapter.service=lily-discord-adapter"

  # Web-Scout - Web search and summarization service
  web-scout:
    image: nstut/web-scout:latest
    container_name: web-scout
    restart: unless-stopped
    ports:
      - "8005:8000"
    env_file:
      - ./Web-Scout/.env
    environment:
      - PORT=8000
    networks:
      nstut-network:
        ipv4_address: 172.18.0.30
    depends_on:
      consul:
        condition: service_healthy
    labels:
      - "traefik.enable=true"
      # Service definition
      - "traefik.http.services.web-scout.loadbalancer.server.port=8000"
      # HTTP API router
      - "traefik.http.routers.web-scout.rule=Host(`web-scout.nstut.cloud`)"
      - "traefik.http.routers.web-scout.entrypoints=websecure"
      - "traefik.http.routers.web-scout.tls.certresolver=myresolver"
      - "traefik.http.routers.web-scout.service=web-scout"

  # Consul - Service Registry
  consul:
    image: hashicorp/consul:latest
    container_name: consul
    restart: unless-stopped
    ports:
      - "8500:8500"
      - "8600:8600/udp"
    networks:
      nstut-network:
        ipv4_address: 172.18.0.100
    command: "agent -dev -client '0.0.0.0' -ui"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8500/v1/status/leader"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    labels:
      - "traefik.enable=true"
      # HTTP API (port 8500)
      - "traefik.http.routers.consul-api.rule=Host(`consul-api.nstut.cloud`)"
      - "traefik.http.routers.consul-api.entrypoints=websecure"
      - "traefik.http.routers.consul-api.tls.certresolver=myresolver"
      - "traefik.http.routers.consul-api.service=consul-api"
      - "traefik.http.services.consul-api.loadbalancer.server.port=8500"
      # UI Dashboard (port 8500 - same port, different router)
      - "traefik.http.routers.consul-ui.rule=Host(`consul.nstut.cloud`)"
      - "traefik.http.routers.consul-ui.entrypoints=websecure"
      - "traefik.http.routers.consul-ui.tls.certresolver=myresolver"
      - "traefik.http.routers.consul-ui.service=consul-ui"
      - "traefik.http.services.consul-ui.loadbalancer.server.port=8500"

networks:
  nstut-network:
    name: nstut-network
    external: true

volumes:
  lily-core-data:
    driver: local
  lily-discord-adapter-data:
    driver: local
