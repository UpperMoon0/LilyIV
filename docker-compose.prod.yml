# Docker Compose for Lily-Core and Lily-Discord-Adapter
# Uses external nstut-network for connectivity

services:
  # Lily-Core Application - Main chatbot service (C++)
  lily-core:
    image: nstut/lily-core
    build: ./Lily-Core
    ports:
      - "8000:8000"
      - "9002:9002"
    env_file:
      - ./Lily-Core/.env
    networks:
      nstut-network:
        ipv4_address: 172.28.0.10
    environment:
      - CONSUL_HTTP_ADDR=consul:8500
    restart: unless-stopped

  # Lily-Discord-Adapter - Discord bot adapter for Lily-Core
  lily-discord-adapter:
    image: nstut/lily-discord-adapter
    build: ./Lily-Discord-Adapter
    ports:
      - "8004:8004"
    env_file:
      - ./Lily-Discord-Adapter/.env
    networks:
      nstut-network:
        ipv4_address: 172.28.0.20
    environment:
      - PYTHONUNBUFFERED=1
      - PORT=8004
      - PYTHONPATH=/app/Lily-Discord-Adapter
      - LILY_CORE_URL=ws://lily-core:9002
      - CONSUL_HTTP_ADDR=consul:8500
    depends_on:
      - lily-core
      - consul
    restart: unless-stopped

  # Consul - Service Registry
  consul:
    image: hashicorp/consul:latest
    ports:
      - "8500:8500"
      - "8600:8600/udp"
    networks:
      nstut-network:
        ipv4_address: 172.28.0.100
    command: "agent -dev -client '0.0.0.0'"
    restart: unless-stopped

networks:
  nstut-network:
    name: nstut-network
    external: true

volumes:
  lily-discord-adapter-data:
    driver: local
